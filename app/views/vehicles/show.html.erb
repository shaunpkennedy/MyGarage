<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>
      <%= @vehicle.title %>
      <% if @overdue_reminders.any? %>
        <span class="badge bg-danger ms-2"><%= @overdue_reminders.size %> overdue</span>
      <% end %>
    </h2>
    <p class="text-muted mb-0"><%= @vehicle.display_name %></p>
  </div>
  <div>
    <%= link_to 'Edit', edit_vehicle_path(@vehicle), class: 'btn btn-outline-secondary btn-sm me-2' %>
    <%= link_to 'Back', vehicles_path, class: 'btn btn-outline-secondary btn-sm' %>
  </div>
</div>

<!-- Key Info Bar -->
<div class="row mb-4">
  <div class="col-md-3 col-6 mb-3">
    <div class="card shadow-sm text-center h-100">
      <div class="card-body">
        <h6 class="text-muted">Current Odometer</h6>
        <h3 class="fw-bold"><%= number_with_delimiter(@vehicle.current_odometer || 0) %></h3>
        <small class="text-muted">miles</small>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="card shadow-sm text-center h-100">
      <div class="card-body">
        <h6 class="text-muted">Average MPG</h6>
        <h3 class="fw-bold"><%= @vehicle.overall_mpg %></h3>
        <small class="text-muted">miles/gallon</small>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="card shadow-sm text-center h-100">
      <div class="card-body">
        <h6 class="text-muted">Last Service</h6>
        <% if @last_service %>
          <h3 class="fw-bold"><%= @last_service.service_type.name %></h3>
          <small class="text-muted"><%= @last_service.log_date&.strftime('%b %d, %Y') %></small>
        <% else %>
          <h3 class="fw-bold">&mdash;</h3>
          <small class="text-muted">No services logged</small>
        <% end %>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="card shadow-sm text-center h-100">
      <div class="card-body">
        <h6 class="text-muted">Next Due</h6>
        <% if @next_due %>
          <h3 class="fw-bold <%= 'text-danger' if @next_due.overdue? %>"><%= @next_due.service_type.name %></h3>
          <small class="<%= @next_due.overdue? ? 'text-danger' : 'text-muted' %>">
            <% if @next_due.overdue? %>
              Overdue by <%= number_with_delimiter(@next_due.miles_remaining.abs) %> mi
            <% else %>
              <%= number_with_delimiter(@next_due.miles_remaining) %> mi remaining
            <% end %>
          </small>
        <% else %>
          <h3 class="fw-bold">&mdash;</h3>
          <small class="text-muted">No reminders set</small>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Fuel Efficiency -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header"><h5 class="mb-0">Fuel Efficiency</h5></div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= @vehicle.overall_mpg %></div>
            <div class="stat-label">Average MPG</div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= @vehicle.most_recent_mpg || '—' %></div>
            <div class="stat-label">Last MPG</div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= @vehicle.previous_mpg || '—' %></div>
            <div class="stat-label">Previous MPG</div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= @vehicle.best_mpg || '—' %></div>
            <div class="stat-label">Best MPG</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cost Analysis -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header"><h5 class="mb-0">Cost Analysis</h5></div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= number_to_currency(@vehicle.cost_per_mile) %></div>
            <div class="stat-label">Cost per Mile</div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= number_to_currency(@vehicle.average_cost_per_fill_up) %></div>
            <div class="stat-label">Avg Fill-Up</div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= number_to_currency(@vehicle.average_cost_per_gallon) %></div>
            <div class="stat-label">Avg $/Gallon</div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-value"><%= number_to_currency(@vehicle.fuel_total_cost + @vehicle.service_total_cost) %></div>
            <div class="stat-label">Total Spent</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex gap-2 flex-wrap">
      <%= link_to 'Add Fill-Up', new_vehicle_fuel_log_path(@vehicle), class: 'btn btn-success' %>
      <%= link_to 'Add Service', new_vehicle_service_log_path(@vehicle), class: 'btn btn-info' %>
      <%= link_to 'Add Reminder', new_vehicle_reminder_path(@vehicle), class: 'btn btn-warning' %>
      <%= link_to 'Reports', vehicle_report_path(@vehicle), class: 'btn btn-primary' %>
      <%= link_to 'Cost Summary', vehicle_cost_summary_path(@vehicle), class: 'btn btn-outline-primary' %>
      <%= link_to 'Vehicle History', vehicle_history_path(@vehicle), class: 'btn btn-outline-dark' %>
      <%= link_to 'Fuel History', vehicle_fuel_logs_path(@vehicle), class: 'btn btn-outline-secondary' %>
      <%= link_to 'Service History', vehicle_service_logs_path(@vehicle), class: 'btn btn-outline-secondary' %>
    </div>
  </div>
</div>

<!-- Maintenance Status -->
<% all_reminders = @overdue_reminders + @approaching_reminders + @ok_reminders %>
<% if all_reminders.any? %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            Maintenance Status
            <% if @overdue_reminders.any? %>
              <span class="badge bg-danger ms-1"><%= @overdue_reminders.size %> overdue</span>
            <% end %>
            <% if @approaching_reminders.any? %>
              <span class="badge bg-warning text-dark ms-1"><%= @approaching_reminders.size %> approaching</span>
            <% end %>
          </h5>
          <%= link_to 'View All', vehicle_reminders_path(@vehicle), class: 'btn btn-sm btn-outline-secondary' %>
        </div>
        <div class="card-body">
          <% all_reminders.each do |reminder| %>
            <%
              if reminder.overdue?
                bar_class = 'bg-danger'
                bar_pct = 100
              elsif reminder.miles_remaining && reminder.next_odometer && reminder.next_odometer > 0
                pct = ((reminder.next_odometer - reminder.miles_remaining).to_f / reminder.next_odometer * 100).clamp(0, 100).round
                bar_pct = pct
                bar_class = pct >= 80 ? 'bg-warning' : 'bg-success'
              else
                bar_pct = 0
                bar_class = 'bg-success'
              end
            %>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <strong><%= reminder.service_type.name %></strong>
                <span class="text-muted small">
                  <% if reminder.overdue? %>
                    <span class="text-danger fw-bold">Overdue by <%= number_with_delimiter(reminder.miles_remaining.abs) %> mi</span>
                  <% elsif reminder.miles_remaining %>
                    Due at <%= number_with_delimiter(reminder.next_odometer) %> mi &middot; <%= number_with_delimiter(reminder.miles_remaining) %> mi remaining
                  <% else %>
                    &mdash;
                  <% end %>
                </span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar <%= bar_class %>" role="progressbar" style="width: <%= bar_pct %>%"></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Recent Activity -->
<% if @recent_activity.any? %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header"><h5 class="mb-0">Recent Activity</h5></div>
        <ul class="list-group list-group-flush">
          <% @recent_activity.each do |entry| %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <% if entry[:type] == :fuel %>
                  <span class="badge bg-success me-2"><i class="bi bi-fuel-pump"></i></span>
                <% else %>
                  <span class="badge bg-primary me-2"><i class="bi bi-wrench"></i></span>
                <% end %>
                <strong><%= entry[:description] %></strong>
                <small class="text-muted ms-2"><%= entry[:date]&.strftime('%b %d, %Y') %></small>
              </div>
              <span class="fw-bold"><%= number_to_currency(entry[:cost]) %></span>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
<% end %>

<!-- Recent Fill-Ups -->
<% recent_fuel_logs = @vehicle.fuel_logs.order(log_date: :desc).limit(5) %>
<% if recent_fuel_logs.any? %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Fill-Ups</h5>
          <%= link_to 'View All', vehicle_fuel_logs_path(@vehicle), class: 'btn btn-sm btn-outline-secondary' %>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Odometer</th>
                <th>Gallons</th>
                <th>$/Gal</th>
                <th>Total</th>
                <th>MPG</th>
              </tr>
            </thead>
            <tbody>
              <% recent_fuel_logs.each do |log| %>
                <tr>
                  <td><%= log.log_date&.strftime('%b %d, %Y') %></td>
                  <td><%= number_with_delimiter(log.odometer) %></td>
                  <td><%= log.gallons %></td>
                  <td><%= number_to_currency(log.price_per_gallon) %></td>
                  <td><%= number_to_currency(log.total_cost) %></td>
                  <td><%= log.mpg || '—' %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<% end %>

<div class="text-end">
  <%= link_to 'Delete Vehicle', @vehicle, data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete #{@vehicle.title}? This will remove all associated logs and reminders." }, class: 'btn btn-outline-danger btn-sm' %>
</div>
