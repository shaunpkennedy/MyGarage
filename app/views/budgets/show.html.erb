<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2><%= @budget.category.titleize %> Budget — <%= @vehicle.title %></h2>
    <p class="text-muted mb-0"><%= @budget.period.titleize %> limit: <%= number_to_currency(@budget.amount) %></p>
  </div>
  <div>
    <%= link_to 'Edit', edit_vehicle_budget_path(@vehicle, @budget), class: 'btn btn-outline-secondary btn-sm me-2' %>
    <%= link_to 'All Budgets', vehicle_budgets_path(@vehicle), class: 'btn btn-outline-secondary btn-sm' %>
  </div>
</div>

<%
  spent = @budget.current_spent
  pct = @budget.percentage_used
  remaining = @budget.amount - spent
  bar_class = case @budget.status
              when :exceeded then 'bg-danger'
              when :approaching then 'bg-warning'
              else 'bg-success'
              end
%>

<div class="row mb-4">
  <div class="col-md-4 col-6 mb-3">
    <div class="card shadow-sm text-center h-100">
      <div class="card-body">
        <h6 class="text-muted">Spent</h6>
        <h3 class="fw-bold"><%= number_to_currency(spent) %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-4 col-6 mb-3">
    <div class="card shadow-sm text-center h-100">
      <div class="card-body">
        <h6 class="text-muted">Budget</h6>
        <h3 class="fw-bold"><%= number_to_currency(@budget.amount) %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-4 col-6 mb-3">
    <div class="card shadow-sm text-center h-100">
      <div class="card-body">
        <h6 class="text-muted">Remaining</h6>
        <h3 class="fw-bold <%= 'text-danger' if remaining.negative? %>"><%= number_to_currency(remaining) %></h3>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between mb-2">
      <span><%= pct %>% used</span>
      <span class="text-muted"><%= @budget.period.titleize %> period</span>
    </div>
    <div class="progress" style="height: 20px;">
      <div class="progress-bar <%= bar_class %>" role="progressbar" style="width: <%= [pct, 100].min %>%">
        <% if pct >= 15 %><%= pct %>%<% end %>
      </div>
    </div>
    <% if @budget.status == :exceeded %>
      <div class="alert alert-danger mt-3 mb-0">
        Budget exceeded by <%= number_to_currency(spent - @budget.amount) %>
      </div>
    <% elsif @budget.status == :approaching %>
      <div class="alert alert-warning mt-3 mb-0">
        Approaching budget limit — <%= number_to_currency(remaining) %> remaining
      </div>
    <% end %>
  </div>
</div>

<% if @budget.category == "fuel" || @budget.category == "total" %>
  <% range = @budget.period == "monthly" ? Time.current.beginning_of_month..Time.current.end_of_month : Time.current.beginning_of_year..Time.current.end_of_year %>
  <% fuel_logs = @vehicle.fuel_logs.where(log_date: range).order(log_date: :desc) %>
  <% if fuel_logs.any? %>
    <div class="card shadow-sm mb-4">
      <div class="card-header"><h5 class="mb-0">Fuel Spending This <%= @budget.period == "monthly" ? "Month" : "Year" %></h5></div>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr><th>Date</th><th>Gallons</th><th class="text-end">Cost</th></tr>
          </thead>
          <tbody>
            <% fuel_logs.each do |log| %>
              <tr>
                <td><%= log.log_date&.strftime('%b %d, %Y') %></td>
                <td><%= log.gallons %></td>
                <td class="text-end"><%= number_to_currency(log.total_cost) %></td>
              </tr>
            <% end %>
            <tr class="fw-bold">
              <td colspan="2">Total</td>
              <td class="text-end"><%= number_to_currency(fuel_logs.sum(:total_cost)) %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
<% end %>

<% if @budget.category == "service" || @budget.category == "total" %>
  <% range ||= @budget.period == "monthly" ? Time.current.beginning_of_month..Time.current.end_of_month : Time.current.beginning_of_year..Time.current.end_of_year %>
  <% service_logs = @vehicle.service_logs.includes(:service_type).where(log_date: range).order(log_date: :desc) %>
  <% if service_logs.any? %>
    <div class="card shadow-sm mb-4">
      <div class="card-header"><h5 class="mb-0">Service Spending This <%= @budget.period == "monthly" ? "Month" : "Year" %></h5></div>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr><th>Date</th><th>Service</th><th class="text-end">Cost</th></tr>
          </thead>
          <tbody>
            <% service_logs.each do |log| %>
              <tr>
                <td><%= log.log_date&.strftime('%b %d, %Y') %></td>
                <td><%= log.service_type.name %></td>
                <td class="text-end"><%= number_to_currency(log.total_cost) %></td>
              </tr>
            <% end %>
            <tr class="fw-bold">
              <td colspan="2">Total</td>
              <td class="text-end"><%= number_to_currency(service_logs.sum(:total_cost)) %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
<% end %>
